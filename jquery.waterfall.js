(function(e){function o(e){if(!e)e="transform";var t=document.defaultView.getComputedStyle(document.body,"");if(t[e])return"";if(t["-webkit-"+e])return"-webkit-";if(t["-moz-"+e])return"-moz-";if(t["-o-"+e])return"-o-";if(t["-khtml-"+e])return"-khtml-";return false}var t=e(window),n=e(window.document),r=e(window.document.body),i=o();var s=function(t,n){this.$el=e(t);this.el=t[0];this._create(n)};s.defaultClass="waterfall";e.extend(s.prototype,{options:{colMinWidth:300,defaultContainerWidth:window.clientWidth,autoresize:true,maxCols:16,updateDelay:25,useCalc:undefined,useTranslate3d:undefined,animateShow:false,reflow:null},_create:function(t){var n=this,r=n.options=e.extend({},n.options,t);this.items=[];n.lastHeights=[];n.lastItems=[];n.colPriority=[];n.baseOrder=[];var i=getComputedStyle(n.el);n.el.style.minHeight=i.height;if(n.$el.css("position")==="static")n.el.style.position="relative";if(r.useCalc===undefined){this.calcPrefix=function(){var e=document.createElement("div");var t=["calc","-webkit-calc","-moz-calc","-o-calc"];for(var n=0;n<t.length;++n){var r=t[n];e.style.cssText="width:"+r+"(1px);";if(e.style.length)return r}}();r.useCalc=!!this.calcPrefix}if(r.useTranslate3d===undefined){r.useTranslate3d=!!o("transform")}var s;if(r.itemSelector){s=n.$el.find(r.itemSelector);s.detach();n.$el.children().remove();n.$el.append(s)}else{s=n.$el.children()}s.each(function(e,t){n.items.push(t);n._initItem(t)});n.lastItem=n.items[n.items.length-1];n.firstItem=n.items[0];n._update();if(r.autoresize){e(window).resize(n.reflow.bind(n))}this._observeMutations()},_observeMutations:function(){if(window.MutationObserver){this.observer=new MutationObserver(function(e){var t=e.length;for(var n=0;n<t;n++){if(e[n].removedNodes.length){this._removedItems(Array.prototype.slice.apply(e[n].removedNodes))}if(e[n].addedNodes.length){this._addedItems(Array.prototype.slice.apply(e[n].addedNodes))}}}.bind(this));this.observer.observe(this.el,{attributes:false,childList:true,characterData:false})}else{this.$el.on("DOMNodeInserted",function(e){var t=(e.originalEvent||e).target;if(t.nodeType!==1)return;this._addedItems([t])}.bind(this))}},reflow:function(){var e=this,t=e.options;window.clearTimeout(e._updateInterval);e._updateInterval=window.setTimeout(e._update.bind(e),t.updateDelay);return e},_addedItems:function(e){var t=this.options,n=e.length;for(var r=0;r<n;r++){var i=e[r];if(i.nodeType!==1)continue;this.items.push(i);this._initItem(i)}for(var r=0;r<n;r++){this._placeItem(e[r])}this.lastItem=this.items[this.items.length-1];this._maximizeHeight()},_removedItems:function(e){var t=e.length,n=this.el.childNodes,r=n.length;this.items.length=0;for(var i=0;i<r;i++){if(n[i]!==1)continue;this.items.push(n[i])}this.lastItem=this.items[this.items.length-1];this._update()},_trigger:function(e,t){try{if(this.options[e])this.options[e].call(this.$el,t);this.$el.trigger(e,[t])}catch(n){throw n}},_initItem:function(e){var t=this.options;var n=e.getAttribute("data-span")||1;n=n==="all"?t.maxCols:Math.max(0,Math.min(~~n,t.maxCols));e.span=n;var r=getComputedStyle(e);e.mr=~~r.marginRight.slice(0,-2);e.ml=~~r.marginLeft.slice(0,-2);e.bt=~~r.borderTopWidth.slice(0,-2);e.bb=~~r.borderBottomWidth.slice(0,-2);e.mt=~~r.marginTop.slice(0,-2);e.mb=~~r.marginBottom.slice(0,-2);e.style.position="absolute";this._setItemWidth(e);var i=e.getAttribute("data-float")||e.getAttribute("data-column");switch(i){case null:e.floatCol=null;break;case"right":case"last":e.floatCol=-n;break;case"left":case"first":e.floatCol=0;break;default:e.floatCol=~~i-1;break}if(t.animateShow){if(t.useTranslate3d){}else{e.style.top=this.lastHeights[this.colPriority[this.colPriority.length-1]]+"px";e.style.left=this.colWidth*this.colPriority[this.colPriority.length-1]+"px"}e.removeAttribute("hidden")}},_initLayoutParams:function(){var e=this,t=e.options,n=window.getComputedStyle(e.el),r=0,i=e.lastItems.length;e.pl=~~n.paddingLeft.slice(0,-2);e.pt=~~n.paddingTop.slice(0,-2);e.pr=~~n.paddingRight.slice(0,-2);e.pb=~~n.paddingBottom.slice(0,-2);e.lastHeights.length=0;e.colPriority.length=0;e.baseOrder.length=0;e.colWidth=e.el.clientWidth-e.pl-e.pr;e.lastItems.length=~~(e.colWidth/t.colMinWidth)||1;var s=t.useTranslate3d?0:e.pt;for(r=0;r<e.lastItems.length;r++){e.lastHeights.push(s);e.baseOrder.push(r);e.colPriority.push(r)}e.colWidth/=e.lastItems.length;if(!t.useCalc||i!==e.lastItems.length){for(var r=e.items.length;r--;){this._setItemWidth(e.items[r])}}return e.lastItems.length},_updateInterval:0,_update:function(e,t){var n=this,r=n.options,i=0,s=e||0,o=t||n.items.length,u=n._initLayoutParams();for(i=s;i<o;i++){n._placeItem(n.items[i])}n._maximizeHeight();n._trigger("reflow")},_setItemWidth:function(e){var t=e.span>this.lastItems.length?this.lastItems.length:e.span,n=this.lastItems.length,r=t/n;if(this.options.useCalc){e.w=100*r;e.style.width=this.calcPrefix+"("+100*r+"% - "+(e.mr+e.ml+(this.pl+this.pr)*r)+"px)"}else{e.w=~~(this.colWidth*t-(e.ml+e.mr));e.style.width=e.w+"px"}},_placeItem:function(e){var t=this,n=t.options;var r=t.lastHeights,s=t.lastItems,o=t.colPriority,u=0,a=0,f=0,l=0,c=0,h=0,p=0,d=e.span>s.length?s.length:e.span,v=0,m=[],g=[],y,b=e.floatCol;if(b){b=b>0?Math.min(b,s.length-d):s.length+b}if(d===1){if(b===null){u=o.shift()}else{u=b;for(l=0;l<o.length;l++){if(o[l]==u){o.splice(l,1);break}}}m.push(u);a=r[u]}else if(d>=s.length){u=0;a=r[o[o.length-1]];m=t.baseOrder.slice();m.length=r.length;o.length=0}else{if(b!==null){u=b;a=Math.max.apply(Math,r.slice(u,u+d))}else{g.length=0;a=Infinity;u=0;for(l=0;l<=s.length-d;l++){g[l]=Math.max.apply(Math,r.slice(l,l+d));if(g[l]<a){u=l;a=g[l]}}}for(l=0;l<o.length;){if(o[l]>=u&&o[l]<u+d){m.push(o.splice(l,1)[0])}else{l++}}}e.top=~~a;if(n.useTranslate3d){var w=100*u/d+"% + "+~~((e.ml+e.mr)*u/d)+"px";e.style[i+"transform"]="translate3d("+this.calcPrefix+"("+w+"), "+e.top+"px, 0)"}else{e.style.top=e.top+"px";e.style.left=t.colWidth*u+t.pl+"px"}e.removeAttribute("hidden");v=t._getBottom(e);for(c=0;c<m.length;c++){s[m[c]]=e;t.lastHeights[m[c]]=v}for(l=o.length;l--;){f=t.lastHeights[o[l]];if(v>=f){Array.prototype.splice.apply(o,[l+1,0].concat(m));break}}if(o.length<r.length){Array.prototype.unshift.apply(o,m)}},_getBottom:function(e){if(!e)return 0;return e.top+e.clientHeight+e.bt+e.bb+e.mb+e.mt},_maximizeHeight:function(){var e=this.options.useTranslate3d?this.pt:0;this.el.style.minHeight=this.lastHeights[this.colPriority[this.colPriority.length-1]]+this.pb+e+"px"}});e.fn.waterfall=function(t,n){if(typeof t=="string"){return e(this).each(function(r,i){e(i).data("waterfall")[t](n)})}else{var r=e(this),i=e.extend({},e.parseDataAttributes(this[0]),t);if(i.width&&!i.colMinWidth){i.colMinWidth=i.width}var o=new s(r,i);if(!r.data("waterfall"))r.data("waterfall",o);return o}};if(!e.parseDataAttributes){e.parseDataAttributes=function(t){var n={};if(t.dataset){e.extend(n,t.dataset)}else{[].forEach.call(t.attributes,function(e){if(/^data-/.test(e.name)){var t=e.name.substr(5).replace(/-(.)/g,function(e,t){return t.toUpperCase()});n[t]=e.value}})}return n}}e(function(){var t=window.waterfall&&window.waterfall.defaultClass||s.defaultClass;e("."+t).each(function(t,n){var r=e(n),i=window.waterfall||{};r.waterfall(i)})})})(window.jQuery||window.Zepto)
